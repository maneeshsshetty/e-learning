{% extends 'base.html' %}

{% block content %}
<style>
    :root {
        --primary-color: #0f172a;
        /* Slate 900 */
        --action-color: #2563eb;
        /* Blue 600 */
        --surface-color: #ffffff;
        --bg-color: #f8fafc;
        /* Slate 50 */
        --text-primary: #1e293b;
        /* Slate 800 */
        --text-secondary: #64748b;
        /* Slate 500 */
        --card-border: 1px solid #e2e8f0;
        --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);

        /* Override Bootstrap Variables */
        --bs-primary: #0f172a;
        --bs-primary-rgb: 15, 23, 42;
        --bs-success: #059669;
        /* Emerald 600 */
        --bs-success-rgb: 5, 150, 105;
        --bs-info: #0891b2;
        /* Cyan 600 */
        --bs-info-rgb: 8, 145, 178;
        --bs-warning: #d97706;
        /* Amber 600 */
        --bs-warning-rgb: 217, 119, 6;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-primary);
    }

    .dashboard-container {
        padding-bottom: 3rem;
    }

    /* Stats Icons (Used in Header) */



    .stats-icon {
        width: 48px;
        height: 48px;
        background-color: #e2e8f0;
        /* Darker for contrast on transparent */
        color: var(--primary-color);
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 0;
    }

    /* Section Headers */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.5rem;
    }

    .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Enrollments */
    .enrollment-card {
        background: var(--surface-color);
        border: var(--card-border);
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: var(--card-shadow);
        height: 100%;
        display: flex;
        flex-direction: column;
        transition: border-color 0.2s;
    }

    .enrollment-card:hover {
        border-color: var(--action-color);
    }

    .course-thumb {
        height: 120px;
        background-color: var(--primary-color);
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2.5rem;
    }

    .status-badge {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        padding: 0.25rem 0.75rem;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border-radius: 0.25rem;
        font-weight: 500;
        font-size: 0.75rem;
        backdrop-filter: blur(4px);
    }



    /* Course List (Right Side) */
    .mini-course-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        transition: background-color 0.2s;
        text-decoration: none;
        color: inherit;
    }

    .mini-course-item:last-child {
        border-bottom: none;
    }

    .mini-course-item:hover {
        background-color: #f8fafc;
    }

    .mini-course-icon {
        width: 40px;
        height: 40px;
        background: #e2e8f0;
        color: var(--text-secondary);
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

<div class="dashboard-container">
    <!-- Unifed Dashboard Header -->
    <div class="dashboard-header mb-5">
        <div class="row g-4 align-items-center">
            <!-- Profile Section -->
            <div class="col-lg-4 d-flex align-items-center gap-3">
                <div class="position-relative">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                        style="width: 64px; height: 64px; font-size: 1.5rem; font-weight: bold;">
                        {{ user.username|first|upper }}
                    </div>
                    <span
                        class="position-absolute bottom-0 end-0 p-1 bg-success border border-white rounded-circle"></span>
                </div>
                <div>
                    <h4 class="fw-bold mb-0">{{ user.username }}</h4>
                    <div class="d-flex align-items-center gap-2 text-muted small">
                        <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-2">Student</span>
                        <span>â€¢</span>
                        <span>{{ now|date:"l, F jS" }}</span>
                    </div>
                </div>
            </div>

            <!-- Stats Section (Divider on large screens) -->
            <div class="col-lg-3 border-start-lg border-end-lg px-lg-4">
                <div class="d-flex align-items-center gap-3">
                    <div class="stats-icon bg-primary bg-opacity-10 text-primary rounded-circle"
                        style="width: 50px; height: 50px;">
                        <i class="bi bi-journal-bookmark-fill fs-4"></i>
                    </div>
                    <div>
                        <h2 class="fw-bold mb-0" id="stats-enrolled">0</h2>
                        <p class="text-muted small mb-0">Courses Enrolled</p>
                    </div>
                </div>
            </div>

            <!-- Upcoming Class Section -->
            <div class="col-lg-5">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="fw-bold mb-0 text-primary"><i class="bi bi-calendar-event me-2"></i>Upcoming Class</h6>
                    <a href="#" class="text-muted small text-decoration-none">View Calendar <i
                            class="bi bi-chevron-right"></i></a>
                </div>
                <!-- Mini Widget for Next Class -->
                <div id="upcoming-classes-header-widget" class="bg-white rounded-3 border p-2">
                    <div class="d-flex align-items-center justify-content-center text-muted small py-2">
                        <span class="spinner-border spinner-border-sm me-2"></span> Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="row g-4">
        <div class="col-12">
            <!-- My Enrollments -->
            <div class="section-header">
                <div class="section-title">
                    <i class="bi bi-mortarboard-fill text-primary"></i> My Learning
                </div>
                <a href="#" class="btn btn-sm btn-outline-primary rounded-pill">View All</a>
            </div>

            <div id="enrollments-grid" class="row g-4 mb-5">
                <!-- Loading State -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>


        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetchData();
    });

    async function fetchData() {
        try {
            const [coursesRes, enrollmentsRes] = await Promise.all([
                fetch('/api/courses/'),
                fetch('/api/enrollments/')
            ]);

            const courses = await coursesRes.json();
            const enrollments = await enrollmentsRes.json();

            updateDashboard(courses, enrollments);
        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }

    function updateDashboard(courses, enrollments) {
        // Update Stats
        document.getElementById('stats-enrolled').textContent = enrollments.length;
        document.getElementById('stats-enrolled').textContent = enrollments.length;

        // 1. Render Enrollments (Main Grid)
        const enrollmentsGrid = document.getElementById('enrollments-grid');
        enrollmentsGrid.innerHTML = '';

        if (enrollments.length === 0) {
            enrollmentsGrid.innerHTML = `
                <div class="col-12 text-center py-5 bg-white rounded-4 shadow-sm">
                    <i class="bi bi-journal-plus fs-1 text-muted mb-3 d-block"></i>
                    <h5>No courses yet</h5>
                    <p class="text-muted">Explore our catalog to start learning</p>
                </div>
            `;
        } else {
            enrollments.forEach(item => {
                const meetBtn = item.meet_link ?
                    `<a href="${item.meet_link}" target="_blank" class="btn btn-primary btn-sm rounded-pill px-3"><i class="bi bi-camera-video me-1"></i> Join</a>` :
                    `<button disabled class="btn btn-light btn-sm rounded-pill px-3 text-muted"><i class="bi bi-clock me-1"></i> No Link</button>`;

                const imageHtml = item.course_photo ?
                    `<img src="${item.course_photo}" alt="${item.course_title}" style="width: 100%; height: 100%; object-fit: cover;">` :
                    `<i class="bi bi-code-square"></i><span class="status-badge">In Progress</span>`;

                const html = `
                <div class="col-md-6">
                    <div class="enrollment-card">
                        <div class="course-thumb">
                            ${imageHtml}
                            ${item.course_photo ? '<span class="status-badge">In Progress</span>' : ''}
                        </div>
                        <div class="p-4 flex-grow-1 d-flex flex-column">
                            <h5 class="fw-bold mb-1">${item.course_title}</h5>
                            <p class="text-muted small mb-3">
                                <i class="bi bi-person-circle me-1"></i> ${item.teacher_name}
                            </p>
                            
                            <div class="class-info bg-light rounded p-2 mb-3 small">
                                ${item.class_description ?
                        `<i class="bi bi-info-circle me-1 text-primary"></i> ${item.class_description}` :
                        '<span class="text-muted fst-italic">No class info available</span>'}
                            </div>

                            <div class="mt-auto pt-3 border-top d-flex justify-content-between align-items-center">
                                ${meetBtn}
                                <small class="text-muted fw-bold">In Progress</small>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                enrollmentsGrid.insertAdjacentHTML('beforeend', html);
            });
        }



        // 3. Render Upcoming Classes Widget (Header)
        const upcomingWidget = document.getElementById('upcoming-classes-header-widget');
        const upcoming = enrollments.filter(e => e.meet_link).slice(0, 1); // Show next one

        if (upcoming.length > 0) {
            const item = upcoming[0];
            // Mock date for demo purposes since API might not have date
            const today = new Date();

            upcomingWidget.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <div class="bg-primary bg-opacity-10 text-primary rounded p-2 text-center" style="min-width: 50px;">
                            <span class="d-block fw-bold h5 mb-0">${today.getDate()}</span>
                            <span class="d-block small text-uppercase" style="font-size: 0.7rem;">${today.toLocaleString('default', { month: 'short' })}</span>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-0 text-dark text-truncate" style="max-width: 180px;">${item.course_title}</h6>
                            <small class="text-danger fw-bold"><i class="bi bi-circle-fill" style="font-size: 6px; vertical-align: middle;"></i> Live Class</small>
                        </div>
                    </div>
                    <a href="${item.meet_link}" target="_blank" class="btn btn-primary btn-sm rounded-pill px-4 fw-bold">
                        Join Now
                    </a>
                </div>
            `;
        } else {
            upcomingWidget.innerHTML = `
                <div class="d-flex align-items-center justify-content-center text-muted small py-2">
                    <i class="bi bi-calendar-check me-2"></i> No upcoming classes right now
                </div>
            `;
        }
    }
</script>
{% endblock %}