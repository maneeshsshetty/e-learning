{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4 text-center">
        <h2>Student Dashboard</h2>
        <p class="text-muted">Find subjects and track your enrollments</p>
    </div>
</div>

<div class="row">
    <!-- Available Courses Section -->
    <div class="col-md-5">
        <div class="card mb-4">
            <div class="card-header">Find a Subject</div>
            <div class="card-body p-0">
                <div id="available-courses-list" class="list-group list-group-flush">
                    <!-- JS will popuate this -->
                    <div class="text-center p-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- My Enrollments Section -->
    <div class="col-md-7">
        <div class="card">
            <div class="card-header">My Enrollments</div>
            <div class="card-body">
                <div id="enrollments-list" class="row">
                    <!-- JS will populate this -->
                    <div class="text-center p-3 w-100">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div id="no-enrollments-msg" class="text-muted text-center py-4 d-none">
                    Not enrolled in any courses.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetchCourses();
        fetchEnrollments();
    });

    // 1. Fetch Available Courses
    function fetchCourses() {
        fetch('/api/courses/')
            .then(response => response.json())
            .then(data => {
                const listContainer = document.getElementById('available-courses-list');
                listContainer.innerHTML = ''; // Clear loading spinner

                if (data.length === 0) {
                    listContainer.innerHTML = '<p class="p-3 text-center text-muted">No courses available.</p>';
                    return;
                }

                data.forEach(course => {
                    // Determine badge color based on if course is free
                    const priceClass = course.is_free ? 'bg-success' : 'bg-primary';

                    // Create HTML Element string
                    const html = `
                    <a href="/dashboard/student/course/${course.id}/"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${course.title}</strong>
                            <br><small class="text-muted">by ${course.teacher_name}</small>
                        </div>
                        <div>
                            <span class="badge ${priceClass} me-2">${course.formatted_price}</span>
                            <span class="badge bg-dark rounded-pill">View</span>
                        </div>
                    </a>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', html);
                });
            })
            .catch(error => console.error('Error fetching courses:', error));
    }

    // 2. Fetch My Enrollments
    function fetchEnrollments() {
        fetch('/api/enrollments/')
            .then(response => response.json())
            .then(data => {
                const listContainer = document.getElementById('enrollments-list');
                const noMsg = document.getElementById('no-enrollments-msg');
                listContainer.innerHTML = ''; // Clear spinner

                if (data.length === 0) {
                    noMsg.classList.remove('d-none');
                    return;
                }

                data.forEach(item => {
                    // Build meet link button if available
                    let meetLinkHtml = '';
                    if (item.meet_link) {
                        meetLinkHtml = `
                        <a href="${item.meet_link}" target="_blank" class="btn btn-primary btn-sm w-100 mb-2">
                            <i class="bi bi-camera-video"></i> Join Google Meet
                        </a>
                        `;
                    } else {
                        meetLinkHtml = `
                        <div class="alert alert-warning py-2 mb-2" style="font-size: 0.9em;">
                            <i class="bi bi-exclamation-triangle"></i> 
                            Teacher hasn't added a meet link yet.
                        </div>
                        `;
                    }

                    // Build class description if available
                    let descriptionHtml = '';
                    if (item.class_description) {
                        descriptionHtml = `
                        <div class="alert alert-info py-2" style="font-size: 0.9em;">
                            <strong>Class Info:</strong><br>
                            ${item.class_description}
                        </div>
                        `;
                    }

                    const html = `
                    <div class="col-md-12 mb-3">
                        <div class="card h-100 border-0 shadow-sm bg-custom-light">
                            <div class="card-body border rounded">
                                <h5 class="card-title">${item.course_title}</h5>
                                <h6 class="card-subtitle mb-3 text-muted">Teacher: ${item.teacher_name}</h6>
                                
                                ${meetLinkHtml}
                                ${descriptionHtml}
                            </div>
                        </div>
                    </div>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', html);
                });
            })
            .catch(error => console.error('Error fetching enrollments:', error));
    }
</script>
{% endblock %}