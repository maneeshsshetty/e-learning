{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4 text-center">
        <h2>Teacher Dashboard</h2>
        <p class="text-muted">Manage your teaching schedule</p>
    </div>
</div>

<div class="row">
    <!-- Available Courses Column -->
    <div class="col-md-5">
        <div class="card mb-4">
            <div class="card-header">Available Courses</div>
            <div class="card-body p-0">
                <ul id="available-courses-list" class="list-group list-group-flush">
                    <!-- JS will populate -->
                    <li class="list-group-item text-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- My Classes Column -->
    <div class="col-md-7">
        <div class="card">
            <div class="card-header">My Classes</div>
            <div class="card-body">
                <div class="accordion accordion-flush" id="myOfferingsAccordion">
                    <!-- JS will populate -->
                    <div class="text-center p-3">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
                <div id="no-classes-msg" class="text-muted text-center py-4 d-none">
                    You have not selected any subjects yet.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Shared Modals -->
<div class="modal fade" id="editClassModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="offering_id" id="edit_offering_id">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Class Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Meeting Link</label>
                        <input type="url" name="meet_link" id="edit_meet_link" class="form-control"
                            placeholder="https://meet.google.com/...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Class Description</label>
                        <textarea name="class_description" id="edit_class_desc" class="form-control"
                            rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="update_details" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addContentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="offering_id" id="content_offering_id">
                <div class="modal-header">
                    <h5 class="modal-title">Add Content</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" name="title" class="form-control" required
                            placeholder="Lesson 1: Introduction">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Video (Optional)</label>
                        <input type="file" name="video" class="form-control" accept="video/*">
                        <div class="form-text">Upload video lectures here.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">File Resource (Optional)</label>
                        <input type="file" name="file" class="form-control" accept=".pdf,.doc,.docx,.ppt,.pptx,.zip">
                        <div class="form-text">Notes, assignments, or slides.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">External Link (Optional)</label>
                        <input type="url" name="link" class="form-control" placeholder="https://...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="add_content" class="btn btn-success">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        Promise.all([fetchCourses(), fetchMyOfferings()]);
    });

    let myTeachingCourseIds = [];

    // Helper to format date
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // Modal Helpers
    function editClassDetails(id, link, desc) {
        document.getElementById('edit_offering_id').value = id;
        document.getElementById('edit_meet_link').value = link;
        document.getElementById('edit_class_desc').value = desc;
        new bootstrap.Modal(document.getElementById('editClassModal')).show();
    }

    function openAddContentModal(id) {
        document.getElementById('content_offering_id').value = id;
        new bootstrap.Modal(document.getElementById('addContentModal')).show();
    }

    async function fetchMyOfferings() {
        try {
            const response = await fetch('/api/offerings/');
            const offerings = await response.json();

            const listContainer = document.getElementById('myOfferingsAccordion');
            const noMsg = document.getElementById('no-classes-msg');
            listContainer.innerHTML = '';

            if (offerings.length === 0) {
                noMsg.classList.remove('d-none');
            } else {
                noMsg.classList.add('d-none');
            }

            myTeachingCourseIds = offerings.map(o => o.course);

            offerings.forEach(offering => {
                // Generate Content List HTML
                let contentHtml = '';
                if (offering.contents && offering.contents.length > 0) {
                    offering.contents.forEach(content => {
                        let icon = '<i class="bi bi-link-45deg fs-4 text-success"></i>';
                        if (content.video) icon = '<i class="bi bi-play-circle-fill fs-4 text-danger"></i>';
                        else if (content.file) icon = '<i class="bi bi-file-earmark-text-fill fs-4 text-primary"></i>';

                        // Escape IDs for JS safety
                        const contentId = content.id;

                        contentHtml += `
                        <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="me-3 text-secondary">${icon}</div>
                                <div>
                                    <div class="fw-semibold">${content.title}</div>
                                    <small class="text-muted">${formatDate(content.created_at)}</small>
                                </div>
                            </div>
                            <form method="post" onsubmit="return confirm('Delete this content?');">
                                {% csrf_token %}
                                <input type="hidden" name="content_id" value="${contentId}">
                                <button type="submit" name="delete_content" class="btn btn-sm btn-outline-danger border-0">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                        `;
                    });
                } else {
                    contentHtml = '<div class="text-center py-3 text-muted small bg-light rounded-3">No content added yet.</div>';
                }

                // Properly escape class description for JS string
                const desc = (offering.class_description || '').replace(/'/g, "\\'").replace(/\n/g, "\\n");

                const html = `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading${offering.id}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapse${offering.id}">
                            <strong>${offering.course_title}</strong>
                        </button>
                    </h2>
                    <div id="collapse${offering.id}" class="accordion-collapse collapse"
                        data-bs-parent="#myOfferingsAccordion">
                        <div class="accordion-body">
                            
                            <!-- Actions Row -->
                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                                <h6 class="fw-bold mb-0">Class Management</h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" type="button" onclick="editClassDetails(${offering.id}, '${offering.meet_link || ''}', '${desc}')">
                                        <i class="bi bi-pencil me-1"></i> Edit Details
                                    </button>
                                    <button class="btn btn-sm btn-success" type="button" onclick="openAddContentModal(${offering.id})">
                                        <i class="bi bi-plus-lg me-1"></i> Add Content
                                    </button>
                                </div>
                            </div>

                            <!-- Class Info -->
                            <div class="bg-light rounded-3 p-3 mb-4">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="small text-muted text-uppercase fw-bold mb-1">Meeting Link</label>
                                        <div>
                                            ${offering.meet_link ?
                        `<a href="${offering.meet_link}" target="_blank" class="text-primary text-decoration-none d-flex align-items-center"><i class="bi bi-camera-video-fill me-2"></i>Join Class</a>`
                        : '<span class="text-muted fst-italic">No link added</span>'}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small text-muted text-uppercase fw-bold mb-1">Description</label>
                                        <div class="small">${offering.class_description || 'No description provided.'}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Content List section -->
                            <h6 class="fw-bold mb-3 border-bottom pb-2">Classroom Content</h6>
                            <div class="list-group list-group-flush mb-3">
                                ${contentHtml}
                            </div>

                        </div>
                    </div>
                </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });

            renderCoursesList(window.cachedCourses || []);

        } catch (error) {
            console.error('Error fetching offerings:', error);
        }
    }

    async function fetchCourses() {
        try {
            const response = await fetch('/api/courses/');
            const courses = await response.json();
            window.cachedCourses = courses;
            renderCoursesList(courses);
        } catch (error) {
            console.error('Error fetching courses:', error);
        }
    }

    function renderCoursesList(courses) {
        const listContainer = document.getElementById('available-courses-list');
        listContainer.innerHTML = '';

        if (courses.length === 0) {
            listContainer.innerHTML = '<li class="list-group-item text-center text-muted">No courses available.</li>';
            return;
        }

        courses.forEach(course => {
            const isTeaching = myTeachingCourseIds.includes(course.id);
            let actionHtml = '';
            if (isTeaching) {
                actionHtml = '<span class="badge bg-dark rounded-pill">Teaching</span>';
            } else {
                actionHtml = `
                <form method="post" action="{% url 'teacher_dashboard' %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="course_id" value="${course.id}">
                    <button type="submit" name="opt_in" class="btn btn-sm btn-outline-dark">Teach this</button>
                </form>
                `;
            }

            const html = `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                ${course.title}
                <div>${actionHtml}</div>
            </li>
            `;
            listContainer.insertAdjacentHTML('beforeend', html);
        });
    }
</script>
{% endblock %}